<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-t">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - Mi Sistema Legal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'dashboard' %}">Mi Sistema Legal</a>
        
        <div>
            {% if user.is_authenticated %}
                <span class="navbar-text me-3">
                    Hola, {{ user.username }}
                </span>
                <a href="{% url 'lista_causas' %}" class="btn btn-outline-secondary btn-sm">Ver Causas</a>
                <form action="{% url 'logout' %}" method="post" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-light btn-sm">Cerrar Sesión</button>
                 </form>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-outline-light">Iniciar Sesión</a>
            {% endif %}
        </div>
    </div>
</nav>

  <div class="container mt-4">
    <h1 class="mb-4">Dashboard de Inteligencia</h1>

    <div class="row">
      <div class="col-lg-3 col-md-6 mb-4"><a href="{% url 'lista_causas' %}" class="text-decoration-none"><div class="card text-white bg-primary h-100"><div class="card-body"><h5 class="card-title">Total Causas</h5><p class="card-text fs-1 fw-bold">{{ total_causas }}</p></div></div></a></div>
        <div class="col-lg-3 col-md-6 mb-4"><a href="{% url 'lista_causas' %}?estado=ACTIVO" class="text-decoration-none"><div class="card text-white bg-success h-100"><div class="card-body"><h5 class="card-title">Causas Activas</h5><p class="card-text fs-1 fw-bold">{{ causas_activas }}</p></div></div></a></div>
        <div class="col-lg-3 col-md-6 mb-4"><a href="{% url 'lista_causas' %}?estado=RECUPERADO" class="text-decoration-none"><div class="card text-white bg-warning h-100"><div class="card-body"><h5 class="card-title">Causas Recuperadas</h5><p class="card-text fs-1 fw-bold">{{ causas_recuperadas }}</p></div></div></a></div>
        <div class="col-lg-3 col-md-6 mb-4"><a href="{% url 'lista_causas' %}?estado=SUSPENDIDO" class="text-decoration-none"><div class="card text-white bg-danger h-100"><div class="card-body"><h5 class="card-title">Causas Suspendidas</h5><p class="card-text fs-1 fw-bold">{{ causas_suspendidas }}</p></div></div></a></div>
        <div class="col-lg-3 col-md-6 mb-4"><a href="{% url 'lista_causas' %}?estado=ARCHIVADO" class="text-decoration-none"><div class="card text-white bg-secondary h-100"><div class="card-body"><h5 class="card-title">Causas Archivadas</h5><p class="card-text fs-1 fw-bold">{{ causas_archivadas }}</p></div></div></a></div>
    </div>

    <hr class="my-4">
    <div class="row mt-4">
        <div class="col-md-8 col-lg-6 mx-auto">
            <div class="card">
                <div class="card-header">
                    Distribución de Causas por Estado
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 40vh; width: 100%; max-width: 500px; margin: auto;">
                        <canvas id="myPieChart" 
                            data-labels="{{ chart_labels|safe }}" 
                            data-data="{{ chart_data|safe }}">
                        </canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Obtenemos los datos que pasamos desde la vista de Django
    // Obtenemos el elemento canvas
    const chartCanvas = document.getElementById('myPieChart');

    // Leemos los datos desde los atributos data-* y los convertimos a un objeto JavaScript
    // El .replace() es un truco para asegurar que las comillas sean compatibles con JSON.
    const labels = JSON.parse(chartCanvas.dataset.labels.replace(/&#x27;/g, '"'));
    const data = JSON.parse(chartCanvas.dataset.data);

    // Y le pasamos el canvas al constructor del gráfico
    new Chart(
    chartCanvas, // <-- Usamos la variable que ya definimos
    config
    );

    // Configuración del gráfico
    const config = {
      type: 'pie', // Tipo de gráfico: de pastel
      data: {
        labels: labels,
        datasets: [{
          label: 'Distribución de Causas',
          data: data,
          backgroundColor: [
            'rgba(40, 167, 69, 0.8)',  // Verde para Activas
            'rgba(255, 193, 7, 0.8)',   // Amarillo para Recuperadas
            'rgba(220, 53, 69, 0.8)',  // Rojo para Suspendidas
            'rgba(108, 117, 125, 0.8)' // Gris para Archivadas
          ],
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
      }
    };

    // Renderizamos el gráfico en nuestro canvas
    new Chart(
      document.getElementById('myPieChart'),
      config
    );
  </script>
</body>
</html>